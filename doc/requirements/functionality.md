# 项目功能需求分析

## 1. 引言

本项目旨在构建一个集成前端、服务器端及网络数据库的旅行信息分享应用。该应用将为用户提供从旅行规划、行中协作到行后分享的全流程服务，并辅以即时通讯和AI智能助手功能，打造一站式的社交化旅行体验。本此文档将详细拆解各个功能模块的需求、业务逻辑及交互流程。

## 2. 功能模块详解

系统主要划分为五个核心功能模块：用户认证模块、旅行核心模块、社交互动模块、AI智能助手模块以及后台管理模块。

### 2.1 用户认证模块 (User Authentication)

该模块是系统的安全基石，负责管理用户身份、权限及个人信息。

#### 2.1.1 注册与登录
*   **功能描述**：
    *   用户可以通过邮箱和密码注册新账户。系统需校验邮箱格式及用户名的唯一性。
    *   支持邮箱/密码登录。登录成功后，系统通过 Session/Cookie 机制维持用户会话，并记录登录IP及User-Agent用于安全审计。
    *   密码在数据库中必须以哈希加盐的形式存储（通过 PBKDF2 或类似算法），严禁明文存储。
*   **业务规则**：
    *   注册时，默认分配 `user` 角色。
    *   登录失败（密码错误或账户不存在）应返回模糊提示，防止枚举攻击。

#### 2.1.2 个人资料管理
*   **功能描述**：
    *   **查看资料**：用户可以查看自己及他人的个人主页，包含头像、昵称、简介 (Bio)、常驻地 (Location) 及注册时间。
    *   **编辑资料**：用户可随时更新自己的头像（支持图片上传）、简介和常驻地。
    *   **修改密码**：已登录用户需验证旧密码后方可设置新密码。
*   **交互流程**：
    *   前端提供表单供用户修改信息，支持头像图片的裁剪或直接上传。
    *   后端接收请求后更新 `users` 表，并自动刷新 `updated_at` 字段。

#### 2.1.3 用户搜索
*   **功能描述**：支持通过用户名模糊搜索平台上的其他用户，便于添加好友或邀请加入行程。

---

### 2.2 旅行核心模块 (Travel Core)

这是系统的核心业务域，采用领域驱动设计 (DDD) 的思想，围绕 `Trip` 聚合根构建。

#### 2.2.1 行程管理 (Trip Management)
*   **功能描述**：
    *   **创建行程**：用户可创建一个新的旅行计划，必填项包括名称、起止日期，可选项包括描述、预算、封面图及可见性（公开/私有）。
    *   **行程列表**：
        *   “我的行程”：展示用户参与的所有行程（包括自己创建的和被邀请的）。
        *   “公开行程”：在广场页展示所有设置为 `public` 的行程，供他人参考。
    *   **状态流转**：行程具有生命周期状态：`Planning` (计划中) -> `In Progress` (进行中) -> `Completed` (已完成) 或 `Cancelled` (已取消)。
        *   仅在 `Planning` 阶段允许随意修改日期范围（可能触发日程结构的重组）。
        *   仅在 `In Progress` 阶段可执行“完成”操作。

#### 2.2.2 日程与活动规划 (Itinerary & Activities)
*   **功能描述**：
    *   **每日视图**：系统根据行程日期范围自动生成每日 (Day 1, Day 2...) 的日程容器。
    *   **活动增删改**：用户可在特定日期下添加活动 (Activity)。
        *   **活动类型**：景点 (Sightseeing)、餐饮 (Dining)、住宿 (Accommodation)、交通 (Transport) 等。
        *   **位置服务**：集成地理编码服务，支持输入模糊地名（如“天安门”）自动解析为经纬度和标准地址。
        *   **时间与花费**：记录活动的开始/结束时间及预估费用。
    *   **智能交通计算**：
        *   当用户在某日添加两个连续活动时，系统会自动调用路径规划服务（基于高德/百度地图API逻辑），计算两个活动之间的交通方式（驾车/公交/步行）、距离及耗时。
        *   生成的交通信息 (Transit) 会作为日程的一部分自动插入活动之间。
    *   **自动重排**：若修改了某个活动的时间，系统会自动校验时间冲突，并重新计算受影响的交通段。

#### 2.2.3 多人协作 (Collaboration)
*   **功能描述**：
    *   **成员邀请**：行程创建者（Admin）可以邀请好友加入行程。**约束**：被邀请者必须是当前用户的“好友”关系。
    *   **角色权限**：
        *   `Admin` (管理员)：拥有所有权限，包括修改行程信息、管理成员、编辑日程。创建者默认为 Admin。
        *   `Member` (成员)：通常仅拥有查看权限或受限的编辑权限（取决于具体业务配置，本项目暂定仅 Admin 可深度编辑，Member 可查看及聊天）。
    *   **权限控制**：系统在领域层严格校验操作权限，例如“只有 Admin 可以移除成员”、“不可移除创建者”。

#### 2.2.4 旅行统计
*   **功能描述**：系统基于行程数据实时生成统计报表，包括总里程、总游玩时间、总交通时间、总预算及实际预估花费。

---

### 2.3 社交互动模块 (Social Interaction)

该模块负责用户之间的连接与内容分享，增强应用的社区属性。

#### 2.3.1 游记/帖子 (Posts)
*   **功能描述**：
    *   **发布动态**：用户可发布图文动态，支持多图上传、标签 (Tags) 选择。
    *   **关联行程**：发布时可选择关联一个已有的行程，便于读者点击跳转查看详细路线。
    *   **信息流 (Feed)**：首页展示公开的帖子流，支持按标签筛选或关键词搜索。
    *   **互动**：支持对他人的帖子进行点赞 (Like) 和评论 (Comment)。评论支持盖楼（父子评论）。

#### 2.3.2 即时通讯 (Chat)
基于 WebSocket (Flask-SocketIO) 实现的实时聊天系统。
*   **功能描述**：
    *   **私聊 (Private Chat)**：
        *   用户可与好友发起 1对1 聊天。
        *   若两人非好友关系，系统将拒绝创建会话。
    *   **群聊 (Group Chat)**：
        *   用户可创建群组，并拉好友入群。
        *   支持群名修改、群成员管理（踢人/转让群主）。
    *   **消息类型**：
        *   **文本**：普通文字消息。
        *   **图片**：支持图片发送与预览。
        *   **行程/帖子分享**：支持将行程卡片或帖子卡片分享到聊天中，点击可直达详情页。
    *   **消息状态**：支持“已读”状态标记，让发送者知道消息是否被阅读。

#### 2.3.3 好友系统
*   **功能描述**：虽然文档未详述好友申请流程，但业务逻辑中存在明确的 `are_friends` 检查。系统需维护 `Friendship` 表，记录用户间的双向关系状态 (`Accepted`, `Pending`)，作为聊天和拉群的前置条件。

---

### 2.4 AI 智能助手模块 (AI Assistant)

集成大语言模型 (LLM) 的智能旅行顾问，利用 RAG (检索增强生成) 技术提供更精准的服务。

#### 2.4.1 智能问答
*   **功能描述**：用户可在专属的 AI 对话页面提问，如“帮我规划一个去云南的五天行程”或“推荐适合亲子游的景点”。

#### 2.4.2 RAG 检索增强
*   **业务流程**：
    1.  **意图识别与关键词提取**：后端接收用户问题，利用 LLM (DeepSeek) 提取核心搜索关键词（处理中文分词）。
    2.  **混合检索**：系统同时在 `Activity` (景点库)、`Trip` (他人公开行程)、`Post` (社区游记) 中进行检索。
    3.  **上下文增强**：将检索到的相关信息（如热门景点、真实游记片段）组装成 Prompt 的一部分。
    4.  **流式生成**：将增强后的 Prompt 发送给大模型，通过 SSE (Server-Sent Events) 或 WebSocket 流式返回生成的回答，提升用户体验。
    5.  **推荐卡片**：在对话气泡下方，系统会自动附带检索到的相关行程或帖子卡片，方便用户点击查看原始数据。

---

### 2.5 后台管理模块 (Admin)

供系统管理员使用的内部管理界面。

*   **功能描述**：
    *   **通用资源管理**：提供基于 RESTful API 的通用接口，可对系统内的任意资源（用户、行程、帖子、评论等）进行 CRUD 操作。
    *   **权限隔离**：严格的中间件拦截，确保只有 `role='admin'` 的用户才能访问 `/api/admin` 下的接口。
    *   **数据审计**：管理员可查看并强制删除违规内容（如恶意帖子、非法行程），或禁用违规用户账号。

## 3. 非功能性需求概览

*   **安全性**：所有敏感操作（修改、删除）必须校验当前用户权限（如“只能修改自己的帖子”）。API 需防范 SQL 注入（通过 ORM）和 XSS 攻击（前端转义）。
*   **性能**：聊天消息需低延迟传输；图片资源建议通过 CDN 或独立文件服务托管；列表接口需支持分页 (Pagination) 以避免大数据量加载。
*   **数据一致性**：涉及多表更新的操作（如“创建行程同时初始化日程”）需在数据库事务 (Transaction) 中执行，确保 ACID 特性。

## 4. 总结

本系统通过模块化的设计，清晰地分离了业务关注点。从底层的数据库设计到上层的应用逻辑，均遵循了成熟的软件工程实践（如 DDD 分层）。功能的丰富性——覆盖了从工具属性（行程规划）到社交属性（聊天、分享）再到智能化属性（AI 助手）的完整闭环，能够很好地满足现代旅行者对一站式旅行服务平台的需求。
